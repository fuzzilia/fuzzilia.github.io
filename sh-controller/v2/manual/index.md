# SH-Controller 説明書

## はじめに

本書はお絵かき補助入力デバイス作成キット、SH-Controller v2 の説明書です。

SH-Controller はソースコードや回路図など作成に必要な情報のほとんどを Web に公開しています。
下記ページにリンクを記載しておりますので、詳しくはこちらを参照してください。

https://fuzzilia.github.io/sh-controller/index.html

<img src="./img/sh-controller-home-url-qr.png" width="100px">

## 各部の名称

SH-Controller はこのような構成になっています。名称に※のついたものは次のページ以降で詳しく説明をします。

![](./img/controller-up.svg)

![](./img/controller-front-down.svg)

### 電源スイッチ

電源スイッチは IC を Bluetooth 対応のものに差し替えたときのみ利用します。

USB ケーブルを PC 等に接続している場合は電源スイッチの状態に関わらず電源が ON になります。

電池で動作させる場合には右にスライドさせると電源を ON、右にスライドさせると電源を OFF にできます。

### 電池蓋

電池蓋の前方を押しながら後ろに引っ張ると蓋が開き、電池ボックスを開けることができます。

TODO 電池蓋を引っ張り、電池ボックスを開いた状態の写真。

電池ボックスは、Bluetooth 対応の IC に差し替えた場合のみ利用します。
ただし、初期の IC でもファームウェアの書き換え時には蓋をあける必要があります。

電池は単４電池 2 本必要です。アルカリ乾電池、ニッケル水素充電池が利用できます。

### LED

どちらの IC の場合にも、この位置に LED があります。

初期の IC の場合は、電源が入っている場合に赤く点灯します。

Bluetooth 対応の IC の場合には、Bluetooth の通信状態などを LED の点滅や色で表示します。
詳しくは、Bluetooth 対応版の説明書に記載します。

### リセットボタン穴(nRF5280 用)

IC の差し替えを行った場合に、ファームウェアを書き込む際に利用します。

Bluetooth 対応の Seeed Studio XIAO nRF52840 (Sense) はこの位置にリセットボタンがあるので、
この穴に爪楊枝の裏側などの補足平たい棒を差し込むことでリセットボタンを押すことができます。

初期の IC である、Seeed Studio XIAO RP2040 ではこちらは使いません。

### USB コネクタ

初期の IC で利用対象のデバイスや設定ツールを利用する PC と接続するための USB ケーブルの差込口です。
IC を Bluetooth に差し替えた場合でも、ファームウェアの書き換えに利用します。

## クイックスタート

この章では、IC が初期の状態での SH-Controller v2 の使い方を記載します。

### 設定の書き込み

まず、どのボタンを押せばどのキーが入力されるかの設定を専用の設定アプリを利用して行います。

設定アプリは WindowsPC、または Mac の Chrome ブラウザ、または Edge ブラウザでのみ利用できます。

対象のブラウザで下記 URL を開いてください。 (Fuzzilia ホームページからでも遷移できます。)

https://fuzzilia.github.io/sh-config/

<img src="./img/sh-config-home.png" width="500px">

このページの「デバイスを選択して設定を作成」から 「SH-Controller nRF52 v2 (右手用)」または「SH-Controller nRF52 v2 (左手用)」を選択し、キー入力設定を作成してください。
ジャイロ有と記載されたものは、IC をジャイロ機能有りのものに差し替えた場合のみ利用できます。
設定内容についての詳しい説明は設定ツールの使い方を参照してください。

設定を作成したら本体に書き込みます。
本体を USB ケーブルで設定ツールを開いている PC と接続してください。

次に設定ツールのデバイス名の右側にある「HID 接続」ボタンをクリックしてください。(無線接続は IC 差し替えた場合のみ利用できます。)
すると、ポップアップで「SH-Controller v2」が選択できるようになりますので、こちらと接続してください。

MacOS の場合、最初の接続時に Chrome に対して入力監視の許可が必要になります。設定画面で許可をし、Chrome を再起動した後に再度同じ操作を行ってください。（再起動時に設定は「ブラウザに保存」して置くことをおすすめします。）

その後、「接続」ボタンが「書き込み」ボタンに変化しますので、これをクリックしてください。
「書き込みが完了しました」のメッセージが表示されれば成功です。
「切断」ボタンをクリックして設定を終了してください。

MacOS の場合、初めて HID 接続をするときにデバイスの open に失敗した旨のメッセージ(英語)が出ることがあります。
このメッセージが出たら、コンピューターを再起動して再度試してみてください。
それでも失敗する場合、Karabiner などのキーボード入力を変換するようなソフトウェアをアップデート、アンインストールなどして再起動してみてください。

### 利用

上記設定書込み後、そのまま設定通りのキー入力ができるようになっています。
動作しないようであれば USB ケーブルを指し直してみてください。

以降、USB ケーブルで対象機器と接続すればそのままキー入力デバイスとして利用できるようになります。

<div style="page-break-after: always;"></div>

## 設定ツールの使い方

### 組み合わせボタン

設定ツールでデバイスを選んだ後は、最初に組み合わせボタンとして利用するボタンの選択を行います。
最大 3 個まで選ぶ事ができます。一つも選ばなくても構いません。

組み合わせボタンとは、それ以外の通常ボタンと組み合わせて押す事で、割り当てるキーの種類を増やすための仕組みです。
例えば、以下のように通常ボタンである左上に対して、2 つの組み合わせボタンを組み合わせることにより、4 種類のキー入力を割り当てることができます。

| 組み合わせボタン | 通常ボタン | キー入力     |
| ---------------- | ---------- | ------------ |
| Z1               | 左上       | A            |
| Z2               | 左上       | B            |
| Z1+Z2            | 左上       | Ctrl+C       |
| なし             | 左上       | Ctrl+Shift+A |
| Z1               | なし       | キー割当不可 |

ただし、この例の最後の様に、組み合わせボタンだけを押すことに対してはキー入力を割り当てることができません。

### キー割り当てについて

キー設定は、一緒に押す組み合わせボタンの押し方毎に設定欄が分かれています。例えば、画像の例だと Z1 と Z2 を押しながら右上ボタンを押すと Carl+C のキー入力する、という意味になります。

<img src="./img/sh-config-key-config-example.png" width="500px">

初期表示状態では組み合わせボタンを押さない、通常ボタンだけを押すパターンの設定欄のみが開いていますが、それ以外の組み合わせに対してキーを割り当てたい場合はクリックして設定欄を開いてください。

### スティックについて

SH-Controller にはアナログスティックがついていますが、これにもキー入力を割り当てることができます。

スティックも通常ボタンと同様、組み合わせボタンと合わせて利用することで複数のキー入力割当を使い分けることができます。

現在、スティックの使い方は大きく分けて「回転タイプ」「方向ボタンタイプ」の 2 種類です。
初期設定は「回転タイプ」ですが、回転と表記されたセレクトボックスをクリックすると方向ボタンタイプに変更することができます。

#### スティックを「回転タイプ」で使う

スティックを倒して回転させ、キーの連打入力を行うタイプです。
時計回り、反時計回りに対してそれぞれキー入力を割り当てることができます。
例えば UNDO/REDO やキャンバスの倍率変更など、連打が必要で対になる操作が存在するようなショートカット入力におすすめです。

回転入力のときにだけ入力できる分割数は、1 回転あたりいくつのキー入力をするかを指定するものです。
数が多いほど、連打数が多くなります。
ただし、利用しているデバイスの制約上そこまで連打が早くないので、大量のキー連打入力になると入力が溢れてしまいますので、注意してください。

#### スティックを「方向ボタンタイプ」で使う

スティックを特定の方向に倒すと対応するキーを入力するタイプです。
ボタンが足りない場合、こちらを利用することでさらに割り当てられるキーの数が増えます。
このタイプは分割数に応じて「4 方向ボタン」「8 方向ボタン」の 2 種類が存在します。
8 方向ボタンは割り当てられるキーの数が多いですが、その分誤操作しやすいため、スティック操作になれてない人は 4 方向ボタンの方がおすすめです。

### データの保存について

設定内容はヘッダー入力欄の「ブラウザに保存」ボタンをクリックすることで保存することができます。
保存すると、初期画面の下側に保存したデータ一覧が表示されるようになり、そちらをクリックすると以前に作成した設定を再現した状態でキー割当設定画面を開くことができます。
保存したデータたからキー割当設定画面を開いた場合、「ブラウザに保存」を押すと以前のデータに対して上書きを行います。

このデータはブラウザ自体に保存されるため、設定を行った PC の同じブラウザでしか利用できません。

設定をテキストデータとして書き出し、異なる PC 間でやり取りする機能も検討中ですが具体的な予定は決まっていません。

<div style="page-break-after: always;"></div>

## 右手用にする

SH-Controller v2 はボタン部を組み替えることにより、右手用に変更できます。

## 部品表

本キットには、以下の部品が含まれています。

- 外装（3D プリンタ製 PLA 一部に接着剤使用）
- ポリカーボネートねじ M3 8mm (×4)
- ポリカーボネートねじ M3 12mm (×3)
- ポリカーボネートナット M3 (×8)
- 電池ボックス　単４ × ２本用　リード線・フタ・穴あき
- メイン基板 (自作)
- トリガー基板 (自作)
- ボタン基板 (自作)
- 基板に実装している部品
  - ３２ビットＲＩＳＣ－Ｖマイコン　ＣＨ３２Ｖ００３Ｆ４Ｐ６
  - 3.3V 出力昇圧 DCDC コンバーター (XCL102 または XCL103 実装済みの既製品基板)
  - ピンソケット（メス）　１ × ７（７Ｐ） (×2)
  - ピンヘッダ
  - スライドスイッチ
  - タクトスイッチ(2P)本体高さ 9.5mm (×10)
  - タクトスイッチ・キャップ (×10)
  - PH コネクタ ベース付ポスト トップ型 4P (×2)
  - PH コネクタ ベース付ポスト サイド型 2P
  - PH コネクタ ベース付ポスト サイド型 4P (×2)
  - switch 互換の joystick
  - molex 505110-0592
- ケーブル (電池ボックスのもの含む)
  - PH コネクタ コンタクト SPH-002T-P0.5L (×18)
  - PH コネクタ ハウジング 4P (×4)
  - PH コネクタ ハウジング 2P (×1)
  - 耐熱ビニル電線 AWG26 (紫)
  - 耐熱ビニル電線 AWG26 (橙)
- Seeed Studio XIAO RP2040
- USB ケーブル USB2.0 Type-A オス ⇔Type-C オス 0.5m
- はんだ付けキット
  - はんだ (太さ 0.8mm 鉛入り)
  - 練習用基板
  - ピンヘッダ

TODO 電池は単 4 2 本。ニッケル水素充電池可
